#!/usr/bin/env ruby

require 'bundler/setup'
root = File.expand_path('../lib',File.dirname(__FILE__))
$: << root
require 'beaver'
require 'location_worker'
require 'sneakers'
require 'sneakers/runner'
require 'logger'
require 'statsd-ruby'

statsd = Statsd.new(ENV['STATSD_HOST'], 9125)

Sneakers.configure(
  vhost: ENV['CT_VHOST'],
  amqp: {
    host: ENV['HOST'],
    port: ENV['PORT'] || 5672,
    user: ENV['CT_USER'] || 'guest',
    pass: ENV['CT_PASS'] || 'guest',
    tls: ENV['TLS'] == "true" ? true : false,
    tls_cert: ENV['CERT'] || nil,
    tls_key: ENV['KEY'] || nil,
    tls_ca_certificates: [ENV['CA']] || nil,
    verify_peer: ENV['VERIFY_PEER'] || false
  },
  daemonize: false,
  log: STDOUT
)

Sneakers.logger.level = Logger::INFO

r = Sneakers::Runner.new([ LocationWorker ])
r.run
